---
description: Threat detection for containerized workloads.
redirect_from:
  - /threat/malware-detection
---

# Container threat detection

:::note

This feature is tech preview. Tech preview features may be subject to significant changes before they become GA.

:::

## Big picture

Get alerts when security threats, such as malware and other suspicious processes, are detected in your cluster.

## Value

{{prodname}} provides a threat detection engine that analyzes observed file and process activity to detect known malicious and suspicious activity.

As part of these threat detection capabilities, {{prodname}} maintains a database of malware file
hashes. This database consists of SHA256, SHA1, and MD5 hashes of executable file contents that are
known to be malicious. Whenever a program is launched in a {{prodname}} cluster, malware
detection generates an alert in the **Security Events Dashboard** if the program's hash matches one that is known
to be malicious.

Our threat detection engine also monitors activity within the containers running in your clusters to detect suspicious behavior and generate corresponding alerts. The threat detection engine monitors the following types of suspicious activity within containers:

- Access to sensitive system files and directories
- Command and Control
- Defense evasion
- Discovery
- Execution
- Impact
- Persistence
- Privilege escalation

## Before you begin...

### Required

{{prodname}} Container threat detection uses eBPF to monitor container activity, and it runs on Linux-based
nodes in a Kubernetes cluster.

Nodes require amd64 (x86_64) architecture CPUs and one of the following distributions:

- Ubuntu Bionic with kernel version 4.15.0 or 5.4.0
- Ubuntu Focal with kernel version 5.4.0, 5.8.0 or 5.11.0
- CentOS 7 or 8
- Fedora 29, 30, 31, 32, 33 or 34
- Amazon Linux 2
- Debian Stretch or later
- Any other distribution with a Linux kernel 5.0 or later that provides BPF Type Format (BTF) for that kernel at the standard place (/sys/kernel/btf/vmlinux)

:::note

If your nodes are running a variant kernel, or a similarly-modern kernel but with another platform,
please open a [Support ticket](https://support.tigera.io/)
so we can bundle the BTF data to precisely match the version of the kernel running on your cluster nodes.

:::

## How to

- [Enable Container threat detection in the managed cluster](#enable-container-threat-detection)
- [Monitor the Security Events page for malicious programs](#monitor-alerts-page-for-malicious-programs)
- [Disable detectors](#disable-detectors)
  - [Disable detector via UI](#disable-detector-via-ui)
  - [Disable detector via RuntimeSecurity Custom Resource](#disable-detector-via-runtimesecurity-custom-resource)

### Enable Container Threat Detection

Container threat detection is disabled by default.

To enable Container threat detection on your managed cluster, go to the **Threat Defense** section in the {{prodname}} UI, and select **Enable Container Threat Detection**.
This will result in Container threat detection running on all nodes in the managed cluster to detect malware and suspicious processes.

Alternatively, Container threat detection can be enabled using kubectl:

```bash
kubectl apply -f - <<EOF
apiVersion: operator.tigera.io/v1
kind: RuntimeSecurity
metadata:
  name: default
EOF
```

### Monitor the Security Events page for malicious programs

If a malicious or suspicious program is run within the cluster, it will be reported on the **Security Events** page of the
{{prodname}} UI.

![malware-alert-example](/img/calico-cloud/malware-alert-example.png)

### Disable detectors

All detectors are enabled by default. You may want to disable detectors that have a large performance impact and/or produce excessive false positive alerts.

:::note

Both of the following, or removal of the entry are equivalent syntax to enable a detector:

```
detectorsConfig:
- disabled: false
  id: persistence-user_modification
```

```
detectorsConfig:
- id: persistence-user_modification
```

:::

#### Disable detector via UI

- In Manager UI, go to **Threat defense&nbsp;>&nbsp;Container Threat Detection**.

- Navigate to **Detector Settings** tab.

- Find your desired detector in the list and toggle it to be disabled. To re-enable it use the same toggle.
![Security Events Dashboard](/img/calico-cloud/container-threat-detection-detector-settings.png)

#### Disable detector via RuntimeSecurity Custom Resource
- Get the ID of the desired detector by disabling in the UI as described above.

  You should see the ID in the RuntimeSecurity CR (May take a few seconds to appear):

    ```bash
    $ kubectl get runtimesecurities default -o yaml
    ```

    ```
    apiVersion: operator.tigera.io/v1
    kind: RuntimeSecurity
    ...
    spec:
      detectorsConfig:
      - disabled: true
        id: persistence-user_modification
    ```

:::note

If duplicate entries are present. The last entry will take precedence.

:::

- Edit the RuntimeSecurity CR:

    To patch entire config:
    ```
    kubectl patch -n tigera-runtime-security runtimesecurities.operator.tigera.io default --type='merge' -p='{"spec":{"detectorsConfig": [{"id": "persistence-user_modification", "disabled": false}]}}'
    ```

    To patch by index. In this example `0`:
    ```
    kubectl patch -n tigera-runtime-security runtimesecurities.operator.tigera.io default --type='json' -p='[{"op": "replace", "path": "/spec/detectorsConfig/0", "value":{"id": "persistence-user_modification", "disabled": false}}]'
    ```


## Container activity logs in Kibana

Lower-level reports for file and process activity are captured for your cluster in Kibana using the index pattern `tigera_secure_ee_runtime*`.
Please note that most of these reports are not usually malicious; they constitute the raw data against which known malicious program fingerprints and activity patterns are compared. Suspicious and known malicious activity is reported on the **Security Events** page of the {{prodname}} UI.
